name: Build OnePlus 8 GKI Kernel with ReSukiSU

on:
  workflow_dispatch: # 支持手动触发

env:
  KERNEL_REPO: "https://github.com/OnePlusOSS/android_kernel_oneplus_sm8250.git"
  KERNEL_BRANCH: "oneplus/sm8250_11.R.91"
  DEFCONFIG: "vendor/kona-perf_defconfig" # 一加8 GKI内核配置
  CLANG_VERSION: "r416183b" # AOSP Clang for Android 12

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          repository: OnePlusOSS/android_kernel_oneplus_sm8250
          ref: ${{ env.KERNEL_BRANCH }}
          path: kernel

      - name: Setup AOSP Clang
        run: |
          wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/${{ env.CLANG_VERSION }}/clang.tar.gz
          tar -xzf clang.tar.gz
          export CLANG_PATH=$(pwd)/clang/bin

      - name: Setup ReSukiSU
        run: |
          cd kernel
          curl -LSs "https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/main/kernel/setup.sh" | bash

      - name: Build kernel
        run: |
          cd kernel
          export PATH="$CLANG_PATH:$PATH"
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_COMPAT=arm-linux-gnueabi-
          export LLVM=1
          export LLVM_IAS=1
          make ${{ env.DEFCONFIG }}
          make -j$(nproc)

      - name: Upload kernel image
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: kernel/arch/arm64/boot/Image.gz
